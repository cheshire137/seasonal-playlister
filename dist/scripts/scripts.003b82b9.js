"use strict";angular.module("seasonSoundApp",["ngCookies","ngResource","ngSanitize","ngAnimate","ngRoute","ui.bootstrap","LocalStorageModule"]).config(["localStorageServiceProvider",function(a){a.setPrefix("seasonSound")}]).filter("startFrom",function(){return function(a,b){return b=parseInt(b,10),a.slice(b)}}),angular.element(document).ready(["$http",function(a){a.get("/config.json",function(a){window.seasonSoundConfig=a})}]);var redirect_user=function(a,b){var c=a.get("user_return_to");c?(a.remove("user_return_to"),b.path(c)):b.path("/")};angular.module("seasonSoundApp").config(["$routeProvider",function(a){a.when("/",{templateUrl:"/views/lastfm_choose_user.html",controller:"LastfmUserChooserCtrl",title:"Choose Last.fm User"}).when("/lastfm/:user",{templateUrl:"/views/years.html",controller:"YearsCtrl",title:"Choose a Season"}).when("/lastfm/:user/:year/:season",{templateUrl:"/views/season.html",controller:"SeasonCtrl",title:"Create a Playlist"}).when("/logged-out/rdio",{resolve:{redirect:["$location","$cookieStore",function(a,b){b.remove("rdio_user"),redirect_user(b,a)}]}}).when("/auth/failure/:strategy/:message",{resolve:{redirect:["$location","$route","$cookieStore",function(a,b,c){var d=b.current.params.strategy;d=d.charAt(0).toUpperCase()+d.slice(1);var e=b.current.params.message;c.put("error","Failed to authenticate with "+d+": "+e),redirect_user(c,a)}]}}).when("/rdio/:user",{resolve:{redirect:["$location","$route","$cookieStore",function(a,b,c){var d=b.current.params.user;d&&c.put("rdio_user",d),redirect_user(c,a)}]}}).when("/lastfm_auth/:lastfm_user",{resolve:{redirect:["$location","$route","$cookieStore",function(a,b,c){var d=b.current.params.lastfm_user;c.put("lastfm_authenticated_user",d),c.put("lastfm_is_authenticated",!0),a.path("/lastfm/"+d)}]}}).when("/access_token=:access_token&token_type=:token_type&expires_in=:expires_in&state=:state",{resolve:{redirect:["$location","$route","$cookieStore",function(a,b,c){var d=function(){console.error("no state came back from Spotify"),redirect_user(c,a)},e=b.current.params.state;if(!e)return void d();if(e!==c.get("spotify_state"))return void d();c.remove("spotify_state");var f=b.current.params.access_token;f&&c.put("spotify_access_token",f),redirect_user(c,a)}]}}).when("/access_token=:access_token&token_type=:token_type&expires_in=:expires_in",{resolve:{redirect:["$location","$route","$cookieStore",function(a,b,c){var d=b.current.params.access_token;d&&c.put("google_access_token",d),redirect_user(c,a)}]}}).otherwise({redirectTo:"/"})}]).run(["$route","$rootScope",function(a,b){b.$on("$routeChangeSuccess",function(){a.current.title?b.title=a.current.title:b.title=""})}]),function(){var a;angular.module("seasonSoundApp").service("NotificationSvc",a=function(){function a(){this.notices=[],this.errors=[]}return a.prototype.wipe_notices=function(){var a,b,c,d,e;for(d=this.notices,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.remove("notice",a.id));return e},a.prototype.wipe_errors=function(){var a,b,c,d,e;for(d=this.errors,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.remove("error",a.id));return e},a.prototype.wipe_notifications=function(){return this.wipe_notices(),this.wipe_errors()},a.prototype.remove=function(a,b){var c,d,e,f,g,h,i;if("error"===a){f=this.errors,h=[];for(d in f)c=f[d],c.id===b&&h.push(this.errors.splice(d,1));return h}g=this.notices,i=[];for(d in g)e=g[d],e.id===b&&i.push(this.notices.splice(d,1));return i},a.prototype.error=function(a){var b;if(a)return console.error(a),b=this.errors.length+1,this.errors.push({message:a,id:b})},a.prototype.notice=function(a){var b;if(a)return b=this.notices.length+1,this.notices.push({message:a,id:b})},a}())}.call(this),function(){angular.module("seasonSoundApp").service("LastfmSvc",["$timeout",function(a){var b;return new(b=function(){function b(){this.api_url="http://ws.audioscrobbler.com/2.0/"}return b.prototype.get_api_url=function(b,c,d){var e,f;return e=null,f=function(f){return function(){var g,h,i;e&&a.cancel(e),h=f.api_url+"?method="+b,h+="&api_key="+window.seasonSoundConfig.lastfm_api_key+"&format=json";for(g in c)i=c[g],h+="&"+g+"="+encodeURIComponent(i);return d(h)}}(this),window.seasonSoundConfig?f():e=a(f,500)},b.prototype.get_user_neighbors_url=function(a,b){var c;return c={user:a},this.get_api_url("user.getneighbours",c,b)},b.prototype.get_user_info_url=function(a,b){var c;return c={user:a},this.get_api_url("user.getinfo",c,b)},b.prototype.get_weekly_chart_list_url=function(a,b){var c;return c={user:a},this.get_api_url("user.getweeklychartlist",c,b)},b.prototype.get_weekly_track_chart_url=function(a,b,c){var d;return d={user:a,from:b.from,to:b.to},this.get_api_url("user.getweeklytrackchart",d,c)},b}())}])}.call(this),function(){angular.module("seasonSoundApp").service("LastfmChartsSvc",["$q","$http","LastfmSvc","localStorageService",function(a,b,c,d){var e;return new(e=function(){function e(){this.year_charts=[],this.user={},this.chart={},this.neighbors=[],this.load_status={charts:!1,chart:!1,neighbors:!1}}return e.prototype.reset_user=function(){var a,b,c,d;c=this.user,d=[];for(a in c)b=c[a],d.push(delete this.user[a]);return d},e.prototype.reset_charts=function(){return this.load_status.charts=!1,this.load_status.neighbors=!1,this.year_charts.length=0,this.neighbors.length=0},e.prototype.initialize_year_charts=function(a){var b,c,d,e,f,g;for(g=[],e=0,f=a.length;f>e;e++)b=a[e],c=b.year(),d=this.year_charts.filter(function(a){return a.year===c})[0],d?g.push(d.charts.push(b)):(d=new YearChart({year:c}),d.charts.push(b),g.push(this.year_charts.push(d)));return g},e.prototype.get_year_chart_from_year_charts=function(a){var b,c,d,e;for(e=this.year_charts,c=0,d=e.length;d>c;c++)if(b=e[c],b.year===a)return b;return!1},e.prototype.load_year_chart=function(a){var b,c,d;a=parseInt(a,10),b=this.get_year_chart_from_year_charts(a);for(c in b)d=b[c],this.chart[c]=d;return this.load_status.chart=!0},e.prototype.get_user_neighbors=function(d){var e,f,g;return e=a.defer(),g=function(a){return function(b,c,d,f){var g,h,i,j;if(b.neighbours)for(g=i=0,j=Math.min(8,b.neighbours.user.length);j>i;g=i+=1)h=b.neighbours.user[g],a.neighbors.push(new LastfmNeighbor(h));return a.load_status.neighbors=!0,e.resolve()}}(this),f=function(a){return function(a,b,c,d){return e.reject({name:"error_response",data:a,status:b,headers:c,config:d})}}(this),c.get_user_neighbors_url(d,function(a){return b.get(a).success(g).error(f)}),e.promise},e.prototype.get_user_info=function(d){var e,f,g;return e=a.defer(),g=function(a){return function(b,c,d,f){var g,h,i;if(b.user){i=new LastfmUser(b.user);for(g in i)h=i[g],a.user[g]=h}return e.resolve()}}(this),f=function(a){return function(a,b,c,d){return e.reject({name:"error_response",data:a,status:b,headers:c,config:d})}}(this),c.get_user_info_url(d,function(a){return b.get(a).success(g).error(f)}),e.promise},e.prototype.get_charts_after_cutoff_date=function(a,b){var c;return c=a.map(function(a){return new LastfmChart(a)}),c.filter(function(a){return a.to_date()>=b})},e.prototype.get_weekly_chart_list_after_date=function(d,e){var f,g,h;return f=a.defer(),h=function(a){return function(b,c,d,g){var h,i;return b.weeklychartlist?(i=b.weeklychartlist.chart.slice(0).reverse(),h=a.get_charts_after_cutoff_date(i,e),a.initialize_year_charts(h),f.resolve()):b.error&&f.reject({name:b.error}),a.load_status.charts=!0}}(this),g=function(a){return function(b,c,d,e){return f.reject({name:"error_response",data:b,status:c,headers:d,config:e}),a.load_status.charts=!0}}(this),c.get_weekly_chart_list_url(d,function(a){return b.get(a).success(h).error(g)}),f.promise},e.prototype.get_weekly_track_chart=function(e,f){var g,h,i,j,k,l,m,n;if(g=a.defer(),j=""+e+"_"+f.from+"_"+f.to,k=d.get(j)){for(m=0,n=k.length;n>m;m++)l=k[m],f.tracks.push(l);g.resolve()}else i=function(a){return function(a){var b,c,e,h;if(a.weeklytrackchart.track){for(h=a.weeklytrackchart.track,c=0,e=h.length;e>c;c++)b=h[c],f.tracks.push(new LastfmTrack(b));return d.set(j,JSON.stringify(f.tracks)),g.resolve()}return a.error?g.reject({name:a.error}):g.resolve()}}(this),h=function(a,b,c,d){return g.reject({name:"error_response",data:a,status:b,headers:c,config:d})},c.get_weekly_track_chart_url(e,f,function(a){return b.get(a).success(i).error(h)});return g.promise},e}())}])}.call(this),function(){angular.module("seasonSoundApp").service("GoogleAuthSvc",["$q","$location","$window",function(a,b,c){var d;return new(d=function(){function b(){this.auth_endpoint="https://accounts.google.com/o/oauth2/auth",this.client_id="1098051467131-5nfhjfn7maf7tc54abh3uk7c27m1g9e1.apps.googleusercontent.com",this.redirect_uri=c.location.origin,this.scopes=["https://www.googleapis.com/auth/musicmanager"]}return b.prototype.authenticate=function(){var a,b,d,e,f,g;b={response_type:"token",client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scopes.join(" ")},d=[];for(a in b)g=b[a],d.push(encodeURIComponent(a)+"="+encodeURIComponent(g));return e=d.join("&"),f=this.auth_endpoint+"?"+e,c.location.href=f},b.prototype.verify=function(b){var c,d;return c=angular.injector(["ng"]),d=this.client_id,c.invoke(["$http","$rootScope",function(c,e){var f;return f=a.defer(),e.$apply(function(){var a,e;return e=function(a){return a.audience===d?f.resolve(a):f.reject({name:"invalid_audience"})},a=function(a,b,c,d){return f.reject({name:"error_response",data:a,status:b,headers:c,config:d})},c({method:"GET",url:"https://www.googleapis.com/oauth2/v1/tokeninfo",params:{access_token:b}}).success(e).error(a)}),f.promise}])},b}())}])}.call(this),function(){angular.module("seasonSoundApp").service("GooglePlaylistSvc",["$q","$http",function(a,b){var c;return new(c=function(){function c(){}return c.prototype.create=function(c,d){var e,f,g;return e=a.defer(),g=function(a){return e.resolve(a)},f=function(a,b,c,d){return e.reject({name:"error_response",data:a,status:b,headers:c,config:d})},b({method:"POST",url:"/google/playlist",params:{name:c.name,description:c.description,is_public:c.is_public,access_token:d}}).success(g).error(f),e.promise},c}())}])}.call(this),function(){angular.module("seasonSoundApp").service("RdioPlaylistSvc",["$q","$http",function(a,b){var c;return new(c=function(){function c(){}return c.prototype.create=function(c,d,e){var f,g,h;return f=a.defer(),h=function(a){return function(a,b,c,d){return f.resolve(a)}}(this),g=function(a){return function(a,b,c,d){return f.reject({name:"error_response",data:a,status:b,headers:c,config:d})}}(this),b({url:"/rdio/playlist",method:"POST",data:{name:c,description:d,tracks:e}}).success(h).error(g),f.promise},c}())}])}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};angular.module("seasonSoundApp").service("TrackCleanupSvc",function(){var b;return new(b=function(){function b(){this.clean_track_name=a(this.clean_track_name,this)}return b.prototype.strip_after_hyphen=function(a){var b;return b=a.indexOf(" - "),b>-1&&(a=a.substring(0,b)),a},b.prototype.strip_square_brackets=function(a){var b,c;return c=a.indexOf("["),c>-1&&(b=a.indexOf("]",c),a=b>-1?a.substring(0,c)+a.substring(b+1):a.substring(0,c)),a},b.prototype.strip_parentheses=function(a){var b,c;return c=a.indexOf("("),c>-1&&(b=a.indexOf(")",c),a=b>-1?a.substring(0,c)+a.substring(b+1):a.substring(0,c)),a},b.prototype.clean_track_name=function(a){var b;return b=this.strip_after_hyphen(a),b=this.strip_square_brackets(b),b=this.strip_parentheses(b),b.trim()},b}())})}.call(this),function(){angular.module("seasonSoundApp").service("RdioCatalogSvc",["$http","TrackCleanupSvc",function(a,b){var c;return new(c=function(){function c(){}return c.prototype.get_artist_search_url=function(a){var b;return b=encodeURIComponent(a),"/rdio/search/artist?query="+b},c.prototype.get_track_search_url=function(a,b){var c;return c=encodeURIComponent(b),"/rdio/search/track?artist_id="+a+"&query="+c},c.prototype.match_lastfm_track=function(a,c,d,e){var f,g,h;return g=c[a],g.matching=!0,h=function(b){return function(){return a<c.length-1?b.match_lastfm_track(a+1,c,d,e):e(d)}}(this),f=function(a){return function(a){return g.matching=!1,g.matched=!0,d.push(a),h()}}(this),this.search_artists(g.artist,function(a){return function(c){return c?a.search_tracks_by_artist(c.id,g.name,function(d){var e;return d?f(d):(e=b.clean_track_name(g.name),a.search_tracks_by_artist(c.id,e,function(a){return a?f(a):(g.matching=!1,g.missing=!0,h())}))}):(g.matching=!1,g.missing=!0,h())}}(this))},c.prototype.match_lastfm_tracks=function(a,b){return this.match_lastfm_track(0,a,[],b)},c.prototype.search_tracks_by_artist=function(b,c,d){var e,f;return f=function(a){return function(a,b,c,e){return a.error?(console.log(a.error),d(void 0)):d(a)}}(this),e=function(a){return function(a,d,e,f){return console.error("search_tracks_by_artist failure",b,c,a)}}(this),a({url:this.get_track_search_url(b,c),method:"GET"}).success(f).error(e)},c.prototype.search_artists=function(b,c){var d,e;return e=function(a){return function(a,b,d,e){return c(a.error?void 0:a)}}(this),d=function(a){return function(a,c,d,e){return console.error("search_artists failure",b,a)}}(this),a({url:this.get_artist_search_url(b),method:"GET"}).success(e).error(d)},c}())}])}.call(this),function(){angular.module("seasonSoundApp").service("SpotifyAuthSvc",["$q","$location","$window","$http","$timeout",function(a,b,c,d,e){var f;return new(f=function(){function b(){this.auth_endpoint="https://accounts.spotify.com/authorize",this.client_id="48843220ee99406d8129b1d710434cd4",this.redirect_uri=c.location.origin,this.scopes=["playlist-modify-public","playlist-modify-private"]}return b.prototype.authenticate=function(a){var b,d,e,f,g,h;d={response_type:"token",client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scopes.join(" "),state:a},e=[];for(b in d)h=d[b],e.push(encodeURIComponent(b)+"="+encodeURIComponent(h));return f=e.join("&"),g=this.auth_endpoint+"?"+f,c.location.href=g},b.prototype.current_user=function(b){var c,f,g,h,i;return f=a.defer(),c=0,i=function(a){return f.resolve(a)},h=function(a,b,d,h){return 502===b&&3>c?e(g,2e3):f.reject({name:"error_response",data:a,status:b,headers:d,config:h})},g=function(){return d({method:"GET",headers:{Authorization:"Bearer "+b},url:"https://api.spotify.com/v1/me"}).success(i).error(h),c+=1},g(),f.promise},b}())}])}.call(this),function(){angular.module("seasonSoundApp").service("SpotifyCatalogSvc",["$q","$http","TrackCleanupSvc",function(a,b,c){var d;return new(d=function(){function d(){}return d.prototype.get_track_search_url=function(a,b){var c,d;return d=encodeURIComponent(b),c=encodeURIComponent(a),"https://api.spotify.com/v1/search?q=track:"+d+"%20"+("artist:"+c+"&type=track")},d.prototype.match_lastfm_track=function(a,b,d,e){var f,g,h,i,j;return g=b[a],g.matching=!0,j=function(c){return function(){return a<b.length-1?c.match_lastfm_track(a+1,b,d,e):e.resolve(d)}}(this),f=function(a){return function(a){return g.matching=!1,g.matched=!0,d.push(a),j()}}(this),i=function(a){return function(a){return f(a)}}(this),h=function(a){return function(){var b,d;return b=c.clean_track_name(g.name),d=function(){return g.matching=!1,g.missing=!0,j()},a.search_tracks_by_artist(g.artist,b).then(i,d)}}(this),this.search_tracks_by_artist(g.artist,g.name).then(i,h)},d.prototype.match_lastfm_tracks=function(b){var c;return c=a.defer(),this.match_lastfm_track(0,b,[],c),c.promise},d.prototype.search_tracks_by_artist=function(c,d){var e,f,g;return e=a.defer(),g=function(a){return function(a,b,c,d){var f;return a.tracks&&a.tracks.items&&a.tracks.items.length>0?(f=a.tracks.items[0],e.resolve(f)):e.reject({name:"missing_track",data:a,status:b,headers:c,config:d})}}(this),f=function(a){return function(a,b,c,d){return e.reject({name:"error_response",data:a,status:b,headers:c,config:d})}}(this),b({url:this.get_track_search_url(c,d),method:"GET"}).success(g).error(f),e.promise},d}())}])}.call(this),function(){angular.module("seasonSoundApp").service("SpotifyPlaylistSvc",["$q","$http",function(a,b){var c;return new(c=function(){function c(){}return c.prototype.create=function(c,d,e){var f,g,h;return f=a.defer(),h=function(a){return function(a,b,c,d){return f.resolve(a)}}(this),g=function(a){return function(a,b,c,d){return f.reject({name:"error_response",data:a,status:b,headers:c,config:d})}}(this),b({url:"https://api.spotify.com/v1/users/"+d+"/playlists",method:"POST",headers:{Authorization:"Bearer "+c,"Content-Type":"application/json"},data:{name:e.name,"public":e.is_public}}).success(h).error(g),f.promise},c.prototype.add_tracks=function(b,c,d,e){var f,g,h,i,j,k,l,m;return k=a.defer(),m="https://api.spotify.com/v1/users/"+c+"/playlists/"+(""+d.id+"/tracks"),f=100,h=e.length,f>=h?(this.add_chunk_of_tracks(b,m,e,k),k.promise):(g=0,l=function(c){return function(){var d,h;return d=a.defer(),h=e.slice(g,g+f),c.add_chunk_of_tracks(b,m,h,d),g+=f,d.promise}}(this),j=function(){return h>g?l(g).then(j,i):k.resolve()},i=function(a){return function(a,b,c,d){return console.error("failed to add chunk",g,a),k.reject({name:"error_response",data:a,status:b,headers:c,config:d})}}(this),l(g).then(j,i),k.promise)},c.prototype.add_chunk_of_tracks=function(a,c,d,e){var f,g;return g=function(a){return function(a,b,c,d){return e.resolve()}}(this),f=function(a){return function(a,b,c,d){return e.reject({name:"error_response",data:a,status:b,headers:c,config:d})}}(this),b({url:c,method:"POST",headers:{Authorization:"Bearer "+a,"Content-Type":"application/json"},data:d.map(function(a){return a.uri})}).success(g).error(f)},c}())}])}.call(this),function(){var a;a=function(){function a(a){this.tracks=[],this.from=a.from,this.to=a.to}return a.prototype.track_count=function(){return this.tracks.length},a.prototype.is_in_season=function(a,b){var c;return c=this.from_date().setHours(0,0,0,0),a=a.setHours(0,0,0,0),b=b.setHours(0,0,0,0),c>=a&&b>=c},a.prototype.is_spring=function(){var a,b,c;return c=this.year(),b=new Date(Date.UTC(c,2,21)),a=new Date(Date.UTC(c,5,20)),this.is_in_season(b,a)},a.prototype.is_summer=function(){var a,b,c;return c=this.year(),b=new Date(Date.UTC(c,5,21)),a=new Date(Date.UTC(c,8,22)),this.is_in_season(b,a)},a.prototype.is_fall=function(){var a,b,c;return c=this.year(),b=new Date(Date.UTC(c,8,23)),a=new Date(Date.UTC(c,11,20)),this.is_in_season(b,a)},a.prototype.is_winter=function(){var a,b,c,d,e,f,g;return g=this.year(),f=11,e=21,c=2,b=20,d=new Date(Date.UTC(g-1,f,e)),a=new Date(Date.UTC(g,c,b)),this.is_in_season(d,a)?!0:(d=new Date(Date.UTC(g,f,e)),a=new Date(Date.UTC(g+1,c,b)),this.is_in_season(d,a))},a.prototype.season=function(){return this.is_spring()?"spring":this.is_summer()?"summer":this.is_fall()?"fall":this.is_winter()?"winter":"unknown"},a.prototype.from_date=function(){return new Date(1e3*this.from)},a.prototype.to_date=function(){return new Date(1e3*this.to)},a.prototype.playlist_name=function(a){return this.tracks.length<1?this.to_s():this.top_artists_str(a)+" - "+this.month_range_str()},a.prototype.top_artists_str=function(a){var b,c,d,e,f,g,h,i,j,k,l;for(d={},l=this.tracks,j=0,k=l.length;k>j;j++)h=l[j],h.play_count>=a&&(b=h.artist,d.hasOwnProperty(b)?d[b]+=h.play_count:d[b]=h.play_count);return i=function(){var a;a=[];for(b in d)e=d[b],a.push([b,e]);return a}(),i.sort(function(a,b){return a[1]<b[1]?1:a[1]>b[1]?-1:0}),f=Math.min(3,i.length),g=i.slice(0,f),function(){var a,b,d;for(d=[],a=0,b=g.length;b>a;a++)c=g[a],d.push(c[0]);return d}().join(", ")},a.prototype.year=function(){return parseInt(moment(this.from_date()).format("YYYY"),10)},a.prototype.same_year=function(){return this.from_date().getFullYear()===this.to_date().getFullYear()},a.prototype.same_month=function(){var a;return a=this.from_date().getMonth()===this.to_date().getMonth()},a.prototype.from_date_str=function(){return this.same_year()?moment(this.from_date()).format("MMMM D"):moment(this.from_date()).format("MMMM D, YYYY")},a.prototype.to_date_str=function(){return this.same_year()&&this.same_month()?moment(this.to_date()).format("D, YYYY"):moment(this.to_date()).format("MMMM D, YYYY")},a.prototype.from_date_utc_str=function(){return this.from_date().toUTCString()},a.prototype.to_date_utc_str=function(){return this.to_date().toUTCString()},a.prototype.month_range_str=function(){return this.same_year()&&this.same_month()?moment(this.from_date()).format("MMM YYYY"):moment(this.from_date()).format("MMM")+"-"+moment(this.to_date()).format("MMM YYYY")},a.prototype.to_s=function(){return this.same_year()&&this.same_month()?""+this.from_date_str()+"-"+this.to_date_str():""+this.from_date_str()+" to "+this.to_date_str()},a}(),("undefined"!=typeof exports&&null!==exports?exports:this).LastfmChart=a}.call(this),function(){var a;a=function(){function a(a){this.user_name=a.name,this.real_name=a.realname,this.real_name&&""===this.real_name.trim()&&(this.real_name=void 0),this.url=a.url,this.match_pct=100*parseFloat(a.match),this.small_image=a.image.filter(function(a){return"small"===a.size})[0]["#text"],this.medium_image=a.image.filter(function(a){return"medium"===a.size})[0]["#text"],this.large_image=a.image.filter(function(a){return"large"===a.size})[0]["#text"],this.extra_large_image=a.image.filter(function(a){return"extralarge"===a.size})[0]["#text"]}return a}(),("undefined"!=typeof exports&&null!==exports?exports:this).LastfmNeighbor=a}.call(this),function(){var a;a=function(){function a(a){var b;this.name=a.name||"untitled",""===this.name.replace(/\s/g,"")&&(this.name="untitled"),this.mbid=a.mbid,this.artist=a.artist["#text"]||"no artist",""===this.artist.replace(/\s/g,"")&&(this.artist="no artist"),this.artist_mbid=a.artist.mbid,this.play_count=a.playcount,this.play_count&&(this.play_count=parseInt(this.play_count,10)),this.url=a.url,this.url&&this.url.indexOf("http://")<0&&(this.url="http://"+this.url),this.url&&(this.url=encodeURI(this.url)),this.id=this.mbid||this.url,this.small_image=a.image.filter(function(a){return"small"===a.size})[0]["#text"],this.medium_image=a.image.filter(function(a){return"medium"===a.size})[0]["#text"],this.large_image=a.image.filter(function(a){return"large"===a.size})[0]["#text"],"no artist"===this.artist?this.artist_url=null:(b=encodeURIComponent(this.artist).replace(/%20/g,"+"),this.artist_url=encodeURI("http://www.last.fm/music/")+b),this.large_image||(this.large_image="/images/missing-track-image.png")}return a}(),("undefined"!=typeof exports&&null!==exports?exports:this).LastfmTrack=a}.call(this),function(){var a;a=function(){function a(a){this.user_name=a.name,this.real_name=a.realname,this.real_name&&""===this.real_name.trim()&&(this.real_name=void 0),this.url=a.url,this.id=a.id,this.country=a.country,this.age=a.age,this.gender=a.gender,this.play_count=parseInt(a.playcount,10),this.date_registered=new Date(1e3*a.registered.unixtime),this.small_image=a.image.filter(function(a){return"small"===a.size})[0]["#text"],this.medium_image=a.image.filter(function(a){return"medium"===a.size})[0]["#text"],this.large_image=a.image.filter(function(a){return"large"===a.size})[0]["#text"],this.extra_large_image=a.image.filter(function(a){return"extralarge"===a.size})[0]["#text"]}return a.prototype.date_registered_str=function(){return moment(this.date_registered).format("MMMM D, YYYY")},a}(),("undefined"!=typeof exports&&null!==exports?exports:this).LastfmUser=a}.call(this),function(){var a;a=function(){function a(a){this.year=a.year,this.charts=[],this.tracks_loaded=!1,this.tracks=[],this.filtered_tracks=[]}return a.prototype.reset_track_flags=function(){var a,b,c,d,e;for(d=this.tracks,e=[],b=0,c=d.length;c>b;b++)a=d[b],a.missing=!1,a.matched=!1,e.push(a.matching=!1);return e},a.prototype.max_play_count=function(){return this.tracks.length<1?1:Math.max.apply(Math,this.tracks.map(function(a){return a.play_count}))},a.prototype.get_play_count_range=function(a){var b,c,d;for(1>a&&(a=1),c=[],b=d=1;a>=1?a>=d:d>=a;b=a>=1?++d:--d)c.push(b);return c},a.prototype.artists=function(){var a,b,c,d,e,f,g,h,i;for(c={},i=this.tracks,g=0,h=i.length;h>g;g++)e=i[g],c[e.artist]=e.artist;return b=function(a,b){return a.toLowerCase()<b.toLowerCase()?-1:a.toLowerCase()>b.toLowerCase()?1:0},a=function(){var a;a=[];for(d in c)f=c[d],a.push(d);return a}().sort(b),["all"].concat(a)},a.prototype.has_track=function(a){return this.tracks.filter(function(b){return b.id===a.id}).length>0},a.prototype.filter_tracks=function(a){var b,c,d,e,f;for(this.filtered_tracks.length=0,f=this.tracks,d=0,e=f.length;e>d;d++)c=f[d],c.matching=!1,c.missing=!1,c.matched=!1,b=!0,a.min_play_count&&(b=b&&c.play_count>=a.min_play_count),a.artist&&"all"!==a.artist&&(b=b&&c.artist===a.artist),b&&this.filtered_tracks.push(c);return this.filtered_tracks.sort(function(a,b){return a.play_count<b.play_count?1:a.play_count>b.play_count?-1:0})},a.prototype.season_chart_count=function(a){switch(a){case"spring":return this.spring_charts().length;case"summer":return this.summer_charts().length;case"fall":return this.fall_charts().length;case"winter":return this.winter_charts().length}},a.prototype.spring_charts=function(){return this.charts.filter(function(a){return a.is_spring()})},a.prototype.summer_charts=function(){return this.charts.filter(function(a){return a.is_summer()})},a.prototype.fall_charts=function(){return this.charts.filter(function(a){return a.is_fall()})},a.prototype.winter_charts=function(){return this.charts.filter(function(a){return a.is_winter()})},a.prototype.each=function(a,b){var c,d,e,f,g,h,i;for(d=0,f=a.length,i=[],g=0,h=a.length;h>g;g++)c=a[g],e=d===f-1,b(c,d,e),i.push(d+=1);return i},a.prototype.each_season=function(a,b){switch(a){case"spring":return this.each_spring(b);case"summer":return this.each_summer(b);case"fall":return this.each_fall(b);case"winter":return this.each_winter(b)}},a.prototype.each_spring=function(a){return this.each(this.spring_charts(),a)},a.prototype.each_summer=function(a){return this.each(this.summer_charts(),a)},a.prototype.each_fall=function(a){return this.each(this.fall_charts(),a)},a.prototype.each_winter=function(a){return this.each(this.winter_charts(),a)},a.prototype.to_json=function(){var a,b,c,d,e;for(a=[],e=this.filtered_tracks,c=0,d=e.length;d>c;c++)b=e[c],a.push({musicbrainz_id:b.mbid,track:b.name,track_url:b.url,artist:b.artist,artist_url:b.artist_url,play_count:b.play_count});return JSON.stringify(a)},a.prototype.to_csv=function(){var a,b,c,d,e,f,g,h;for(a="data:text/csv;charset=utf-8,",a+="MusicBrainz ID,",a+="Track,",a+="Track URL,",a+="Artist,",a+="Artist URL,",a+="Play Count\n",d=function(a){return'"'+a.replace(/"/g,"'")+'"'},b=0,c=this.filtered_tracks.length,h=this.filtered_tracks,f=0,g=h.length;g>f;f++)e=h[f],a+=d(e.mbid)+",",a+=d(e.name)+",",a+=(e.url?d(e.url):"")+",",a+=d(e.artist)+",",a+=(e.artist_url?d(e.artist_url):"")+",",a+=e.play_count,c-1>b&&(a+="\n"),b+=1;return a},a}(),("undefined"!=typeof exports&&null!==exports?exports:this).YearChart=a}.call(this),function(){angular.module("seasonSoundApp").controller("NotificationsCtrl",["$scope","$cookieStore","NotificationSvc",function(a,b,c){var d;return a.notices=c.notices,a.errors=c.errors,a.remove=function(a,b){return c.remove(a,b)},d=b.get("error"),d?(c.error(d),b.remove("error")):void 0}])}.call(this),function(){angular.module("seasonSoundApp").controller("LastfmUserChooserCtrl",["$scope","$location","$cookieStore","LastfmChartsSvc",function(a,b,c,d){return a.lastfm_user=d.user,a.lastfm_auth={is_authenticated:c.get("lastfm_is_authenticated"),user_name:c.get("lastfm_authenticated_user")},a.go_to_seasons_list=function(){return b.path("/lastfm/"+a.lastfm_user.user_name)},a.get_authenticated_scrobbles=function(){return b.path("/lastfm/"+a.lastfm_auth.user_name)},a.init_lastfm_auth=function(){var a;return a=window.seasonSoundConfig.lastfm_api_key,window.location.href="http://www.last.fm/api/auth/?api_key="+a+"&cb="+window.location.origin+"/lastfm_auth"}}])}.call(this),function(){angular.module("seasonSoundApp").controller("YearsCtrl",["$scope","$routeParams","$cookieStore","NotificationSvc","LastfmChartsSvc",function(a,b,c,d,e){var f;return a.lastfm_user=e.user,a.load_status=e.load_status,a.year_charts=e.year_charts,a.lastfm_neighbors=e.neighbors,a.chart_filters={},a.wipe_notifications=function(){return d.wipe_notifications()},b.user!==c.get("lastfm_user")&&(e.reset_user(),c.put("lastfm_user",b.user),e.reset_charts()),a.lastfm_user.user_name=c.get("lastfm_user"),a.load_status.charts||(f=a.lastfm_user.user_name,e.get_user_info(f),a.$watch("lastfm_user.date_registered",function(){var b;return(b=a.lastfm_user.date_registered)?e.get_weekly_chart_list_after_date(f,b):void 0})),a.load_status.neighbors||e.get_user_neighbors(f),a.slice_range=function(a,b){var c,d,e,f;if(d=[],!a)return d;if(a.length>0)for(c=e=0,f=a.length;b>0?f>e:e>f;c=e+=b)d.push(c);return d},a.is_season_visible=function(a,b){var c,d;if(c=new Date,b<c.getFullYear())return!0;if(d=c.getMonth()+1,"spring"===a&&d>=3&&6>d)return!0;if("summer"===a&&d>=6&&9>d)return!0;if("fall"===a&&d>=9&&12>d)return!0;if("winter"===a){if(d>=1&&3>d)return!0;if(12===d)return!0}return!1}}])}.call(this),function(){angular.module("seasonSoundApp").controller("SeasonCtrl",["$scope","$location","$window","$routeParams","$cookieStore","NotificationSvc","LastfmChartsSvc","GoogleAuthSvc","GooglePlaylistSvc","RdioCatalogSvc","RdioPlaylistSvc","SpotifyAuthSvc","SpotifyCatalogSvc","SpotifyPlaylistSvc",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o,p,q,r,s;return a.lastfm_user=g.user,a.load_status=g.load_status,a.year_charts=g.year_charts,a.year_chart=g.chart,a.track_filters={min_play_count:3,artist:"all"},a.music_service={rdio:!1,google:!1,spotify:!1},a.season={name:d.season,label:void 0},a.auth_status={google:{have_token:!1,access_token:e.get("google_access_token"),is_verified:!1},rdio:{have_token:!1,user:e.get("rdio_user")},spotify:{have_token:!1,access_token:e.get("spotify_access_token"),user:e.get("spotify_user")}},a.playlist={name:"",description:"Created with SeasonSound.",is_public:!0},a.saved_playlist={id:null},a.play_count_range=[],a.page_info={page:0,per_page:10,total:1},a.go_back=function(){return f.wipe_notifications(),g.reset_charts(),a.play_count_range.length=0,a.saved_playlist.id=null,a.track_filters.min_play_count=3,a.track_filters.artist="all",a.music_service.rdio=!1,a.music_service.google=!1,a.music_service.spotify=!1,a.page_info.page=0,a.page_info.total=1},a.season.label=a.season.name.charAt(0).toUpperCase()+a.season.name.slice(1),d.user!==e.get("lastfm_user")&&(e.put("lastfm_user",d.user),g.reset_charts()),a.lastfm_user.user_name=e.get("lastfm_user"),a.load_status.charts||(r=a.lastfm_user.user_name,g.get_user_info(r),a.$watch("lastfm_user.date_registered",function(){var b;return(b=a.lastfm_user.date_registered)?g.get_weekly_chart_list_after_date(r,b):void 0})),p=function(b,c){var d,e,f,g;for(g=b.tracks,e=0,f=g.length;f>e;e++)d=g[e],a.year_chart.has_track(d)||a.year_chart.tracks.push(d);return c?a.year_chart.tracks_loaded=!0:void 0},s=function(b,c,d){var e,f,h;return h=a.lastfm_user.user_name,f=function(){return p(b,d)},e=function(){return a.year_chart.tracks_loaded=!0},g.get_weekly_track_chart(h,b).then(f,e)},a.$watch("load_status.charts",function(){return a.load_status.charts?(g.load_year_chart(d.year),a.year_chart.season_chart_count(a.season.name)<1?a.year_chart.tracks_loaded=!0:a.year_chart.each_season(a.season.name,s)):void 0}),q=function(){var b;return b=Math.ceil(a.year_chart.filtered_tracks.length/a.page_info.per_page),1>b&&(b=1),a.page_info.total=b},o=function(){var b;if(a.year_chart.tracks_loaded&&a.track_filters)return a.year_chart.filter_tracks(a.track_filters),a.saved_playlist.id=null,q(),a.page_info.page>a.page_info.total&&(a.page_info.page=0),b=a.year_chart.max_play_count(),a.play_count_range=a.year_chart.get_play_count_range(b),a.play_count_range.length<1?a.play_count_range.push(1):void 0},a.$watch("year_chart.tracks_loaded",function(){var b;if(a.year_chart.tracks_loaded&&a.track_filters)return b=a.year_chart.max_play_count(),b<a.track_filters.min_play_count?a.track_filters.min_play_count=b:b>3&&(a.track_filters.min_play_count=3),
a.play_count_range=a.year_chart.get_play_count_range(b),o(),a.playlist.name=""+a.lastfm_user.user_name+" "+(""+a.season.label+" "+a.year_chart.year)}),a.$watch("track_filters.min_play_count",o),a.$watch("track_filters.artist",o),a.$watch("year_chart.tracks.length",o),a.download_csv=function(){var b,d;return b=a.year_chart.to_csv(),d=c.open(encodeURI(b),"_blank"),d.focus()},a.download_json=function(){var b,d,e;return b=a.year_chart.to_json(),d="data:application/json,"+b.replace(/([[{,])/g,"$1%0a"),e=c.open(d,"_blank"),e.focus()},a.google_authenticate=function(){return e.put("user_return_to",b.url()),h.authenticate()},a.spotify_authenticate=function(){var a;return e.put("user_return_to",b.url()),a=Math.random().toString(36).substring(7),e.put("spotify_state",a),l.authenticate(a)},a.spotify_logout=function(){return a.auth_status.spotify.have_token=!1,a.auth_status.spotify.access_token="",a.auth_status.spotify.user="",e.remove("spotify_access_token"),e.remove("spotify_user")},a.rdio_authenticate=function(){return e.put("user_return_to",b.url()),c.location.href="/auth/rdio"},a.rdio_logout=function(){return e.put("user_return_to",b.url()),c.location.href="/logout/rdio"},a.$watch("auth_status.rdio.user",function(){var b;return b=a.auth_status.rdio.user,a.auth_status.rdio.have_token=b&&""!==b}),a.$watch("auth_status.spotify.access_token",function(){var b,c,d;return d=a.auth_status.spotify.access_token,a.auth_status.spotify.have_token=d&&""!==d,a.auth_status.spotify.have_token?(c=function(b){return a.auth_status.spotify.user=b.id,e.put("spotify_user",a.auth_status.spotify.user)},b=function(){return a.auth_status.spotify.access_token="",a.auth_status.spotify.have_token=!1,e.remove("spotify_access_token")},l.current_user(d).then(c,b)):void 0}),a.$watch("auth_status.google.access_token",function(){var b,c,d;return d=a.auth_status.google.access_token,a.auth_status.google.have_token=d&&""!==d,a.auth_status.have_token?(c=function(b){return a.auth_status.google.is_verified=!0,a.auth_status.google.have_token=!0},b=function(){return a.auth_status.google.is_verified=!1,a.auth_status.google.access_token="",a.auth_status.google.have_token=!1,e.remove("google_access_token")},h.verify(d).then(c,b)):void 0}),a.create_google_playlist=function(){var b,c;return a.music_service.google=!0,a.music_service.rdio=!1,a.music_service.spotify=!1,a.saved_playlist.id=null,a.year_chart.reset_track_flags(),c=function(a){return f.notice("Created Google Music playlist!"),console.log("created Google Music playlist",a)},b=function(a){return f.error("Failed to create Google Music playlist."),console.error("failed to create Google Music playlist",a)},i.create(a.playlist,a.auth_status.access_token).then(c,b)},a.create_rdio_playlist=function(){var b;return a.music_service.google=!1,a.music_service.rdio=!0,a.music_service.spotify=!1,a.saved_playlist.id=null,a.year_chart.reset_track_flags(),b=function(b){var c,d,e,g,h;return d=function(b){var c,d,e;f.notice("Created Rdio playlist!"),e=[];for(c in b)d=b[c],e.push(a.saved_playlist[c]=d);return e},c=function(a){return f.error("Failed to create Rdio playlist."),console.error("failed to create Rdio playlist",a)},g=function(){var a,c,d;for(d=[],a=0,c=b.length;c>a;a++)e=b[a],d.push(e.id);return d}(),h=g.join(","),k.create(a.playlist.name,a.playlist.description,h).then(d,c)},j.match_lastfm_tracks(a.year_chart.filtered_tracks,b)},a.create_spotify_playlist=function(){var b,c;return a.music_service.google=!1,a.music_service.rdio=!1,a.music_service.spotify=!0,a.saved_playlist.id=null,a.year_chart.reset_track_flags(),c=function(b){var c,d;return c=function(c){var d,e;return a.saved_playlist.url=c.external_urls.spotify,a.saved_playlist.id=c.id,a.saved_playlist.name=c.name,a.saved_playlist.is_public=c["public"],e=function(){return f.notice("Created Spotify playlist!")},d=function(a){return f.error("Failed to add tracks to Spotify playlist."),console.error(a.error.message)},n.add_tracks(a.auth_status.spotify.access_token,a.auth_status.spotify.user,c,b).then(e,d)},d=function(a){return f.error("Failed to create Spotify playlist."),console.error("failed to create Spotify playlist",a)},n.create(a.auth_status.spotify.access_token,a.auth_status.spotify.user,a.playlist).then(c,d)},b=function(){return console.error("failed to match Spotify tracks to Last.fm tracks")},m.match_lastfm_tracks(a.year_chart.filtered_tracks).then(c,b)}}])}.call(this);